name: Build Android APK
on:
  push:
    branches: [ master, main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
        - debug
        - release
jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ› ï¸ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
          cache: true
      
      - name: ğŸ“¦ Install dependencies
        run: flutter pub get
      
      - name: ğŸ§ª Run tests
        run: flutter test
      
      - name: ğŸ”¨ Build APK
        run: |
          if [ "${{ github.event.inputs.build_type }}" == "release" ]; then
            flutter build apk --release
            mv build/app/outputs/flutter-apk/app-release.apk app-release.apk
          else
            flutter build apk --debug
            mv build/app/outputs/flutter-apk/app-debug.apk app-debug.apk
          fi
      
      - name: ğŸ“¤ Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: "*.apk"
          retention-days: 30
      
      - name: ğŸ¯ Create Release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          files: "*.apk"
          tag_name: v1.0.${{ github.run_number }}
          name: Release v1.0.${{ github.run_number }}
          draft: false
          prerelease: false
          body: |
            # ğŸ‰ å±å¹•æƒé™ç®¡ç†æµ‹è¯•APP
            
            ## ğŸ“± åº”ç”¨ä¿¡æ¯
            - **ç‰ˆæœ¬**: v1.0.${{ github.run_number }}
            - **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            - **æäº¤**: ${{ github.sha }}
            
            ## ğŸ“¦ ä¸‹è½½è¯´æ˜
            ä¸‹è½½ä¸‹æ–¹çš„APKæ–‡ä»¶ï¼Œä¼ è¾“åˆ°Androidè®¾å¤‡å®‰è£…å³å¯
            
            ## ğŸ” æµ‹è¯•è¦ç‚¹
            1. æ‰“å¼€APPï¼Œç¡®è®¤è“è‰²ä¸»é¢˜ç•Œé¢
            2. ç‚¹å‡»å³ä¸‹è§’æµ®åŠ¨æŒ‰é’®ï¼Œæµ‹è¯•å±å¹•çŠ¶æ€åˆ‡æ¢
            3. å¼€å¯è‡ªåŠ¨ç®¡ç†ï¼Œä½“éªŒæ™ºèƒ½æƒé™æ§åˆ¶
            4. æŸ¥çœ‹å®æ—¶ç»Ÿè®¡å’Œæ“ä½œæ—¥å¿—
            
            ## âš¡ å¿«é€Ÿå¼€å§‹
            è¯¦ç»†æµ‹è¯•æŒ‡å—è¯·æŸ¥çœ‹é¡¹ç›®ä¸­çš„ TEST_GUIDE.md
            
            ---
            *æ„å»ºäº ${{ github.event.repository.updated_at }}*